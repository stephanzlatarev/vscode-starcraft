<!DOCTYPE html>
<html>

<style>
.row {
  display: flex;
  align-items: center;
  line-height: 1;
}
.inrow {
  margin-right: 2px;
}
.button {
  cursor: pointer;
  color: inherit;
  font-size: small;
  font-weight: bolder;
  text-transform: uppercase;
  border-radius: 20%;
}
.button:hover {
  filter: brightness(2);
}
.on {
  border: 2px solid darkgray;
}
.off {
  border: 2px solid transparent;
}
</style>

<body>
  <div class="row">
    <span id="clock"></span>
    &nbsp;
    <img id="icon-minerals" width="16" height="16" src="" />
    <span id="minerals"></span>
    &nbsp;
    <img id="icon-vespene" width="16" height="16" src="" />
    <span id="vespene"></span>
    &nbsp;
    <img id="icon-supply" width="16" height="16" src="" />
    <span id="supply"></span>
  </div>
  <div id="speed" class="row">
    <span class="inrow" style="color: gray; font-size: small; font-weight: bold;">SPEED</span>
    <div id="speed-0" title="Fast speed">&#x1F3C3;</div>
    <div id="speed-1" title="Clock time">&#x1F559;</div>
    <div id="speed-2" title="x2 slower">x2</div>
    <div id="speed-4" title="x4 slower">x4</div>
    <div id="speed-8" title="x8 slower">x8</div>
    <div id="speed-16" title="x16 slower">x16</div>
    <div id="speed-null" title="Pause">&#x23F8;</div>
  </div>
  <div id="controls">
    <div id="back" class="button" style="display: none">&#x23EE; 1 frame</div>
    <div id="forth" class="button" style="display: none">&#x23ED; 1 frame</div>
    <div id="skip" class="button" style="display: none">&#x23ED; 1 min</div>

    <div>
      <span id="mouse" class="button">&#x1F5B1; mouse</span>
      <span id="action-select">selects unit</span>
      <span id="action-spawn" style="display: none">
        spawns <span id="owner" style="cursor: pointer">enemy</span> <select id="action-spawn-types"></select>
      </span>
      <span id="action-kill" style="display: none">kills unit</span>
    </div>

    <div id="botplay" class="button" style="display: none">&#x1F916; bot play</div>
    <div id="botsync" class="button" style="display: none">&#x1F916; bot sync</div>
    <div id="fog" class="button" style="display: none">&#x1F441; toggle fog</div>
  </div>
</body>

<script>
const COMMANDS = ["back", "botplay", "botsync", "fog", "forth", "owner", "skip"];
const SPEEDS = [0, 1, 2, 4, 8, 16, null]; // null = paused
const LOOPS_PER_SECOND = 22.4;
const LOOPS_PER_MINUTE = LOOPS_PER_SECOND * 60;

const vscode = acquireVsCodeApi();
const actionSpawnTypes = document.getElementById("action-spawn-types");

let action = {};
let config = {};
let types = [];
let icons;

function setIcons(path) {
  if (path && (path !== icons)) {
    document.getElementById("icon-minerals").src = path + "minerals.png";
    document.getElementById("icon-vespene").src = path + "vespene.png";
    document.getElementById("icon-supply").src = path + "supply.png";
    icons = path;
  }
}

function setControls(c, a) {
  config = c;
  action = a;

  for (const command of COMMANDS) {
    document.getElementById(command).style.display = ((config[command] === false) || (controls[command] === false)) ? "none" : "block";
  }

  if ((config.mouse === false) || (action.mode === "select")) {
    document.getElementById("action-kill").style.display = "none";
    document.getElementById("action-select").style.display = "inline";
    document.getElementById("action-spawn").style.display = "none";
  } else if (action.mode === "spawn") {
    actionSpawnTypes.value = String(action.type);
    document.getElementById("owner").innerHTML = (action.owner === 1) ? "own" : "enemy";
    document.getElementById("owner").style.display = "inline";

    document.getElementById("action-kill").style.display = "none";
    document.getElementById("action-select").style.display = "none";
    document.getElementById("action-spawn").style.display = "inline";
  } else if (action.mode === "kill") {
    document.getElementById("action-kill").style.display = "inline";
    document.getElementById("action-select").style.display = "none";
    document.getElementById("action-spawn").style.display = "none";
  }
}

function setSpeed(selection) {
  for (const speed of SPEEDS) {
    document.getElementById("speed-" + speed).className = "button inrow " + ((speed === selection) ? "on" : "off");
  }
}

function setTypes(data) {
  types = data;

  const options = [];

  for (const type of types) {
    options.push(`<option value="${type.id}">${type.name}</option>`);
  }

  actionSpawnTypes.innerHTML = options.join("");
  if (action.type) actionSpawnTypes.value = String(action.type);
}

function setObservation(loop, player) {
  if (loop >= 0) {
    const minutes = Math.floor(loop / LOOPS_PER_MINUTE);
    const seconds = Math.floor(loop / LOOPS_PER_SECOND) % 60;
    const mm = (minutes >= 10) ? minutes : "0" + minutes;
    const ss = (seconds >= 10) ? seconds : "0" + seconds;

    document.getElementById("clock").innerHTML = `${mm}:${ss} (${loop})`;
  }

  if (player) {
    document.getElementById("minerals").innerHTML = player.minerals;
    document.getElementById("vespene").innerHTML = player.vespene;
    document.getElementById("supply").innerHTML = player.foodUsed + "/" + player.foodCap;
  }
}

window.addEventListener("message", function({ data }) {
  switch (data.type) {
    case "observation": return setIcons(data.icons) & setObservation(data.loop, data.player);
    case "controls": return setControls(data.config, data.action) & setSpeed(data.speed);
    case "types": return setTypes(data.types);
  }
});

for (const command of COMMANDS) {
  document.getElementById(command).addEventListener("click", () => {
    vscode.postMessage({ event: command });
  });
}

for (const speed of SPEEDS) {
  document.getElementById("speed-" + speed).addEventListener("click", () => {
    vscode.postMessage({ event: "speed", speed });
  });
}

document.getElementById("mouse").addEventListener("click", () => {
  if (action.mode === "kill") {
    action.mode = "select";
  } else if (action.mode === "select") {
    if (config.mouse !== false) {
      action.mode = "spawn";
      action.owner = 2;
      action.type = Number(actionSpawnTypes.value);
    }
  } else if (action.mode === "spawn") {
    action.mode = "kill";
    delete action.owner;
    delete action.type;
  }

  vscode.postMessage({ event: "mouse", action });
});

actionSpawnTypes.addEventListener("change", (event) => {
  action.type = Number(actionSpawnTypes.value);
  vscode.postMessage({ event: "mouse", action });
});

</script>

</html>
