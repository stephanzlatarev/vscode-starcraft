<!DOCTYPE html>
<html>

<style>
.button {
  cursor: pointer;
  color: black;
  font-size: small;
  font-weight: bolder;
  text-transform: uppercase;
}
.button:hover {
  color: blue;
}
</style>

<body>
  <div>
    <span id="clock"></span>
    <span id="player" style="display: none">
      &nbsp;
      <svg width="10" height="10" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" rx="2" ry="2" width="10" height="10" fill="#87CEFA"/></svg>
      <span id="minerals">10</span>
      &nbsp;
      <svg width="10" height="10" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" rx="2" ry="2" width="10" height="10" fill="#32CD32"/></svg>
      <span id="vespene">20</span>
      &nbsp;
      <svg width="10" height="10" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" rx="2" ry="2" width="10" height="10" fill="#CE87FA"/></svg>
      <span id="supply">30</span>
    </span>
  </div>
  <div id="controls">
    <div id="back" class="button" style="display: none">&#x23EE; 1 frame</div>
    <div id="forth" class="button" style="display: none">&#x23ED; 1 frame</div>
    <div id="pause" class="button" style="display: none">&#x23F8; pause</div>
    <div id="resume" class="button" style="display: none">&#x23F5; resume</div>
    <div id="skip" class="button" style="display: none">&#x23ED; 1 min</div>
  </div>
</body>

<script>
const LOOPS_PER_SECOND = 22.4;
const LOOPS_PER_MINUTE = LOOPS_PER_SECOND * 60;

const vscode = acquireVsCodeApi();
let config = {};
let isStarted;

const commands = {
  back: () => {},
  forth: () => {},
  pause: () => showControls({ pause: false, skip: false }),
  resume: () => showControls({ back: false, forth: false, resume: false }),
  skip: () => {},
};

function showControls(state) {
  for (const id in commands) {
    document.getElementById(id).style.display = ((config[id] === false) || (state[id] === false)) ? "none" : "block";
  }
}

function setConfig(data) {
  config = data;

  showControls({});

  for (const id in commands) {
    if (config[id] !== false) commands[id]();
  }
}

function setObservation(loop, player) {
  if (loop >= 0) {
    const minutes = Math.floor(loop / LOOPS_PER_MINUTE);
    const seconds = Math.floor(loop / LOOPS_PER_SECOND) % 60;
    const mm = (minutes >= 10) ? minutes : "0" + minutes;
    const ss = (seconds >= 10) ? seconds : "0" + seconds;

    if (!isStarted) {
      document.getElementById("player").style.display = "inline";
      commands.resume();
    }

    document.getElementById("clock").innerHTML = `${mm}:${ss} (${loop})`;
    isStarted = true;
  }

  if (player) {
    document.getElementById("minerals").innerHTML = player.minerals;
    document.getElementById("vespene").innerHTML = player.vespene;
    document.getElementById("supply").innerHTML = player.foodUsed + "/" + player.foodCap;
  }
}

window.addEventListener("message", function({ data }) {
  switch (data.type) {
    case "config": return setConfig(data.config);
    case "observation": return setObservation(data.loop, data.player);
    default: if (commands[data.type]) commands[data.type]();
  }
});

for (const command in commands) {
  document.getElementById(command).addEventListener("click", () => {
    vscode.postMessage({ event: command });
  });
}

</script>

</html>
